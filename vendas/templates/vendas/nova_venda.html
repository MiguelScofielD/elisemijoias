{% extends "base.html" %}
{% block title %}Nova Venda{% endblock %}

{% block content %}

<h2 class="mb-4">ðŸ›’ Nova Venda</h2>

<div class="row">

    <!-- LEITOR DE CÃ“DIGO -->
    <div class="col-md-4">
        <div class="card shadow-sm mb-4">
            <div class="card-body">

                <h6 class="text-muted mb-3">
                    Leitura de CÃ³digo de Barras
                </h6>

                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-danger">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}


                <!-- FORMULÃRIO PDV (SEM BOTÃƒO) -->
                <form method="post" action="{% url 'vendas:adicionar_codigo' %}">
                    {% csrf_token %}

                    <input
                        type="text"
                        name="codigo_barras"
                        class="form-control form-control-lg"
                        placeholder="Leia o cÃ³digo do produto"
                        autofocus
                        onfocus="this.select();"
                        value="{{ codigo_invalido }}"
                    >

                </form>

            </div>
        </div>
    </div>

    <!-- CARRINHO -->
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-body">

                <h6 class="text-muted mb-3">
                    Itens no Carrinho
                </h6>

                {% if carrinho %}
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Produto</th>
                            <th class="text-center">Qtd</th>
                            <th class="text-end">PreÃ§o</th>
                            <th class="text-end">Subtotal</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>

                        {% for pid, item in carrinho.items %}
                        <tr>
                            <td><strong>{{ item.nome }}</strong></td>
                            <td class="text-center">{{ item.quantidade }}</td>
                            <td class="text-end">R$ {{ item.preco }}</td>
                            <td class="text-end">
                                R$ {{ item.preco|floatformat:2 }}
                            </td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-danger"
                                   href="{% url 'vendas:remover_do_carrinho' pid %}">
                                   Remover
                                </a>
                            </td>
                        </tr>
                        {% endfor %}

                    </tbody>
                </table>

                <div class="d-flex justify-content-end mt-3">
                    <h4>
                        Total:
                        <span class="text-success">
                            R$ {{ total }}
                        </span>
                    </h4>
                </div>

                <div class="d-flex justify-content-end mt-3">
                    <a href="{% url 'vendas:confirmar_venda' %}"
                       class="btn btn-success btn-lg">
                        Finalizar Venda
                    </a>
                </div>

                {% else %}
                    <p class="text-muted text-center mb-0">
                        Carrinho vazio. Leia um cÃ³digo de barras.
                    </p>
                {% endif %}

            </div>
        </div>
    </div>

</div>

<!-- GARANTIR FOCO APÃ“S REDIRECT -->
<script>
document.addEventListener("DOMContentLoaded", function () {
    const campo = document.querySelector('input[name="codigo_barras"]');
    if (campo) {
        campo.focus();
    }
});
</script>

{% endblock %}
